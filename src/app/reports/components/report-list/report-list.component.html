<div class="report-list-container">
  <div class="container" role="region" aria-label="Listado de reportes ciudadanos">
    <div class="row mb-4">
      <div class="col-md-8">
        <h1 class="h2">Reportes Ciudadanos</h1>
        <p class="text-muted mb-0">Visualiza y gestiona todos los reportes ciudadanos.</p>
      </div>
      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <a routerLink="/reports/new" class="btn btn-success" aria-label="Registrar nuevo reporte">
          Registrar reporte
        </a>
      </div>
    </div>

    <section class="card mb-4" aria-labelledby="filtersHeading">
      <div class="card-body">
        <h2 id="filtersHeading" class="visually-hidden">Filtros de búsqueda</h2>
        @if (isOnline() === false) {
          <div class="alert alert-warning mb-4" role="status" aria-live="polite">
            Operando sin conexión. Los cambios se sincronizarán automáticamente cuando vuelva la
            conectividad.
          </div>
        }
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label" for="filterCategory">Categoría</label>
            <select
              id="filterCategory"
              class="form-control"
              [ngModel]="categoryFilter()"
              (ngModelChange)="categoryFilter.set($event); onFilterChange()"
            >
              <option [ngValue]="undefined">Todas las categorías</option>
              @for (category of categories; track category) {
                <option [value]="category">{{ category }}</option>
              }
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label" for="filterStatus">Estado</label>
            <select
              id="filterStatus"
              class="form-control"
              [ngModel]="statusFilter()"
              (ngModelChange)="statusFilter.set($event); onFilterChange()"
            >
              <option [ngValue]="undefined">Todos los estados</option>
              @for (status of statuses; track status) {
                <option [value]="status">{{ status }}</option>
              }
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label" for="filterSearch">Buscar</label>
            <div class="input-group">
              <input
                id="filterSearch"
                type="text"
                class="form-control"
                placeholder="Buscar en títulos, descripciones o ubicaciones..."
                [ngModel]="searchTerm()"
                (ngModelChange)="onSearchChange($event)"
              />
              <button class="btn btn-outline-secondary" type="button" aria-label="Aplicar búsqueda">
                Buscar
              </button>
            </div>
          </div>

          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-outline-secondary w-100" type="button" (click)="clearFilters()">
              Limpiar filtros
            </button>
          </div>
        </div>
      </div>
    </section>

    @if (loading()) {
      <div class="text-center py-5" role="status" aria-live="polite">
        <div class="spinner-border text-primary" role="presentation"></div>
        <p class="mt-2 mb-0">Cargando reportes…</p>
      </div>
    }

    @if (error() && !loading()) {
      <div class="alert alert-danger" role="alert">
        {{ error() }}
      </div>
    }

    @if (!loading() && !error() && filteredReports().length === 0) {
      <div class="card text-center py-5" role="region" aria-label="Mensaje sin resultados">
        <div class="card-body">
          <h2 class="card-title h5">No se encontraron reportes</h2>
          <p class="card-text">No hay reportes que coincidan con los criterios de búsqueda.</p>
          @if (searchTerm() || categoryFilter() || statusFilter()) {
            <button class="btn btn-primary" type="button" (click)="clearFilters()">
              Ver todos los reportes
            </button>
          }
        </div>
      </div>
    }

    @if (!loading() && !error() && filteredReports().length > 0) {
      <div class="table-responsive">
        <table class="table table-hover" aria-describedby="reportListSummary">
          <caption id="reportListSummary" class="visually-hidden">
            Listado de reportes ciudadanos con filtros y opciones de gestión
          </caption>
          <thead>
            <tr>
              <th scope="col">Título</th>
              <th scope="col">Categoría</th>
              <th scope="col">Ubicación</th>
              <th scope="col">Estado</th>
              <th scope="col">Fecha</th>
              <th scope="col">Reportado por</th>
              <th scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (report of paginatedReports(); track report.id) {
              <tr [class.offline-row]="isOfflineReport(report)">
                <td>
                  <strong>{{ report.title }}</strong>
                  <div class="text-muted small">
                    {{ report.description | slice: 0 : 80 }}
                    <span *ngIf="(report.description?.length ?? 0) > 80" aria-hidden="true">
                      …
                    </span>
                  </div>
                  @if (isOfflineReport(report)) {
                    <div class="badge badge-offline" role="status" aria-live="polite">
                      {{ getPendingActionLabel(report.pendingAction) }}
                    </div>
                  }
                </td>
                <td>
                  <span class="badge bg-light text-dark">
                    {{ getCategoryIcon(report.category) }} {{ getCategoryLabel(report.category) }}
                  </span>
                </td>
                <td>{{ report.location }}</td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(report.status)">
                    {{ report.status }}
                  </span>
                </td>
                <td>
                  <div>{{ report.createdAt | date: 'dd/MM/yyyy' }}</div>
                  <div class="text-muted small">{{ report.createdAt | date: 'HH:mm' }}</div>
                </td>
                <td>{{ report.userName }}</td>
                <td>
                  <div
                    class="btn-group btn-group-sm"
                    role="group"
                    aria-label="Acciones sobre el reporte"
                  >
                    <a
                      [routerLink]="['/reports', report.id]"
                      class="btn btn-outline-primary"
                      aria-label="Ver detalles del reporte"
                    >
                      Ver
                    </a>
                    <a
                      [routerLink]="['/reports', report.id, 'edit']"
                      class="btn btn-outline-secondary"
                      aria-label="Editar reporte"
                    >
                      Editar
                    </a>
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      (click)="deleteReport(report.id!)"
                      aria-label="Eliminar reporte"
                    >
                      Eliminar
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      @if (totalPages() > 1) {
        <nav aria-label="Paginación de reportes">
          <ul class="pagination justify-content-center">
            <li class="page-item" [class.disabled]="currentPage() === 1">
              <button class="page-link" type="button" (click)="prevPage()">Anterior</button>
            </li>

            @for (page of [].constructor(totalPages()); track page; let i = $index) {
              <li class="page-item" [class.active]="currentPage() === i + 1">
                <button class="page-link" type="button" (click)="currentPage.set(i + 1)">
                  {{ i + 1 }}
                </button>
              </li>
            }

            <li class="page-item" [class.disabled]="currentPage() === totalPages()">
              <button class="page-link" type="button" (click)="nextPage()">Siguiente</button>
            </li>
          </ul>
        </nav>
      }

      <p class="text-center text-muted mt-3 mb-0">
        Mostrando {{ paginatedReports().length }} de {{ filteredReports().length }} reportes (página
        {{ currentPage() }} de {{ totalPages() }})
      </p>
    }
  </div>
</div>
